import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';
import dotenv from 'dotenv';

// åŠ è½½çŽ¯å¢ƒå˜é‡
dotenv.config();

const prisma = new PrismaClient();

async function main() {
  console.log('ðŸŒ± å¼€å§‹æ•°æ®åº“ç§å­æ•°æ®åˆå§‹åŒ–...');

  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç®¡ç†å‘˜è´¦å·
  const existingAdmin = await prisma.user.findFirst({
    where: { role: 'ADMIN' },
  });

  if (existingAdmin) {
    console.log('âœ… ç®¡ç†å‘˜è´¦å·å·²å­˜åœ¨ï¼Œè·³è¿‡ç”¨æˆ·åˆ›å»º');
  } else {

    // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦å·
    const hashedPassword = await bcrypt.hash('admin123', 10);

    const admin = await prisma.user.create({
      data: {
        email: 'admin@emall.com',
        username: 'admin',
        password: hashedPassword,
        role: 'ADMIN',
        isActive: true,
        profile: JSON.stringify({
          firstName: 'ç®¡ç†å‘˜',
          lastName: 'ç³»ç»Ÿ',
          phone: '13800138000',
          avatar: null,
        }),
      },
    });

    console.log('âœ… é»˜è®¤ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸ:');
    console.log('   é‚®ç®±: admin@emall.com');
    console.log('   ç”¨æˆ·å: admin');
    console.log('   å¯†ç : admin123');
    console.log('   è§’è‰²: ADMIN');
  }

  // åˆ›å»ºæ™®é€šç”¨æˆ·
  const existingUsers = await prisma.user.findMany({
    where: { role: 'CUSTOMER' },
  });

  if (existingUsers.length === 0) {
    const userPassword = await bcrypt.hash('user123', 10);

    const users = await Promise.all([
      prisma.user.create({
        data: {
          email: 'zhang.wei@example.com',
          username: 'zhangwei',
          password: userPassword,
          role: 'CUSTOMER',
          isActive: true,
          profile: JSON.stringify({
            firstName: 'å¼ ',
            lastName: 'ä¼Ÿ',
            phone: '13812345678',
            avatar: null,
          }),
        },
      }),
      prisma.user.create({
        data: {
          email: 'li.ming@example.com',
          username: 'liming',
          password: userPassword,
          role: 'CUSTOMER',
          isActive: true,
          profile: JSON.stringify({
            firstName: 'æŽ',
            lastName: 'æ˜Ž',
            phone: '13987654321',
            avatar: null,
          }),
        },
      }),
      prisma.user.create({
        data: {
          email: 'wang.fang@example.com',
          username: 'wangfang',
          password: userPassword,
          role: 'CUSTOMER',
          isActive: true,
          profile: JSON.stringify({
            firstName: 'çŽ‹',
            lastName: 'èŠ³',
            phone: '13765432109',
            avatar: null,
          }),
        },
      }),
      prisma.user.create({
        data: {
          email: 'chen.jie@example.com',
          username: 'chenjie',
          password: userPassword,
          role: 'CUSTOMER',
          isActive: true,
          profile: JSON.stringify({
            firstName: 'é™ˆ',
            lastName: 'æ°',
            phone: '13654321098',
            avatar: null,
          }),
        },
      }),
    ]);

    console.log('âœ… æ™®é€šç”¨æˆ·åˆ›å»ºæˆåŠŸ:');
    users.forEach(user => {
      console.log(`   ç”¨æˆ·å: ${user.username}, é‚®ç®±: ${user.email}, å¯†ç : user123`);
    });
  } else {
    console.log('âœ… æ™®é€šç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
  }

  // åˆ›å»ºä¸€äº›ç¤ºä¾‹åˆ†ç±»
  const categories = await Promise.all([
    prisma.category.create({
      data: {
        name: 'ç”µå­äº§å“',
        description: 'æ‰‹æœºã€ç”µè„‘ã€æ•°ç äº§å“ç­‰',
      },
    }),
    prisma.category.create({
      data: {
        name: 'æœè£…éž‹å¸½',
        description: 'ç”·è£…ã€å¥³è£…ã€éž‹å­ã€é…é¥°ç­‰',
      },
    }),
    prisma.category.create({
      data: {
        name: 'å®¶å±…ç”¨å“',
        description: 'å®¶å…·ã€è£…é¥°ã€ç”Ÿæ´»ç”¨å“ç­‰',
      },
    }),
  ]);

  console.log('âœ… ç¤ºä¾‹åˆ†ç±»åˆ›å»ºæˆåŠŸ');

  // åˆ›å»ºä¸€äº›ç¤ºä¾‹äº§å“
  const products = await Promise.all([
    prisma.product.create({
      data: {
        name: 'iPhone 15 Pro',
        description: 'æœ€æ–°æ¬¾è‹¹æžœæ‰‹æœºï¼Œé…å¤‡A17 ProèŠ¯ç‰‡',
        price: 7999.0,
        stock: 50,
        categoryId: categories[0].id,
        status: 'ACTIVE',
        imageUrls: JSON.stringify([
          'https://m.media-amazon.com/images/I/81CgtwSII3L._AC_SX679_.jpg',
          'https://mineo.jp/_mg/_uploads/files/099d9582bc590af1_iPhone15_black_front_380x600_rev01.png',
        ]),
      },
    }),
    prisma.product.create({
      data: {
        name: 'ç»å…¸ç™½Tæ¤',
        description: '100%çº¯æ£‰ï¼Œèˆ’é€‚é€æ°”ï¼Œç»å…¸ç™¾æ­',
        price: 99.0,
        stock: 200,
        categoryId: categories[1].id,
        status: 'ACTIVE',
        imageUrls: JSON.stringify([
          'https://ydot-official.com/cdn/shop/files/YS25-13_2_1024x1024.jpg',
        ]),
      },
    }),
    prisma.product.create({
      data: {
        name: 'åŒ—æ¬§é£Žå°ç¯',
        description: 'ç®€çº¦è®¾è®¡ï¼ŒæŠ¤çœ¼LEDå…‰æº',
        price: 299.0,
        stock: 30,
        categoryId: categories[2].id,
        status: 'ACTIVE',
        imageUrls: JSON.stringify([
          'https://www.nikki-tr.co.jp/shop/html/html/upload/save_image/02151530_58a3f58f7dc7e.jpg',
        ]),
      },
    }),
  ]);

  console.log('âœ… ç¤ºä¾‹äº§å“åˆ›å»ºæˆåŠŸ');

  // åˆ›å»ºä¸€äº›ç¤ºä¾‹ä¼˜æƒ åˆ¸
  const existingCoupons = await prisma.coupon.findMany();

  if (existingCoupons.length === 0) {
    await Promise.all([
      prisma.coupon.create({
        data: {
          code: 'WELCOME10',
          name: 'æ–°ç”¨æˆ·æ¬¢è¿Žåˆ¸',
          description: 'æ–°ç”¨æˆ·ä¸“äº«10%æŠ˜æ‰£',
          type: 'PERCENTAGE',
          value: 10,
          minAmount: 100,
          maxDiscount: 50,
          isActive: true,
          startDate: new Date(),
          endDate: new Date('2026-12-31T23:59:59.999Z'), // 2026å¹´12æœˆ31æ—¥è¿‡æœŸ
          usageLimit: 1000,
          usedCount: 0,
        },
      }),
      prisma.coupon.create({
        data: {
          code: 'SAVE50',
          name: 'æ»¡å‡åˆ¸',
          description: 'æ»¡500å‡50å…ƒ',
          type: 'FIXED_AMOUNT',
          value: 50,
          minAmount: 500,
          isActive: true,
          startDate: new Date(),
          endDate: new Date('2026-12-31T23:59:59.999Z'), // 2026å¹´12æœˆ31æ—¥è¿‡æœŸ
          usageLimit: 500,
          usedCount: 0,
        },
      }),
      prisma.coupon.create({
        data: {
          code: 'FREESHIP',
          name: 'å…è¿è´¹åˆ¸',
          description: 'æ»¡200å…è¿è´¹',
          type: 'FREE_SHIPPING',
          value: 0,
          minAmount: 200,
          isActive: true,
          startDate: new Date(),
          endDate: new Date('2026-12-31T23:59:59.999Z'), // 2026å¹´12æœˆ31æ—¥è¿‡æœŸ
          usageLimit: 2000,
          usedCount: 0,
        },
      }),
      prisma.coupon.create({
        data: {
          code: 'SUMMER20',
          name: 'å¤å­£å¤§ä¿ƒåˆ¸',
          description: 'å¤å­£ä¸“äº«20%æŠ˜æ‰£ï¼Œæœ€é«˜ä¼˜æƒ 100å…ƒ',
          type: 'PERCENTAGE',
          value: 20,
          minAmount: 300,
          maxDiscount: 100,
          isActive: true,
          startDate: new Date(),
          endDate: new Date('2026-08-31T23:59:59.999Z'), // 2026å¹´8æœˆ31æ—¥è¿‡æœŸ
          usageLimit: 800,
          usedCount: 0,
        },
      }),
    ]);

    console.log('âœ… ç¤ºä¾‹ä¼˜æƒ åˆ¸åˆ›å»ºæˆåŠŸ:');
    console.log('   WELCOME10 - æ–°ç”¨æˆ·æ¬¢è¿Žåˆ¸ (10%æŠ˜æ‰£)');
    console.log('   SAVE50 - æ»¡å‡åˆ¸ (æ»¡500å‡50)');
    console.log('   FREESHIP - å…è¿è´¹åˆ¸ (æ»¡200å…è¿è´¹)');
    console.log('   SUMMER20 - å¤å­£å¤§ä¿ƒåˆ¸ (20%æŠ˜æ‰£)');
    console.log('   æ‰€æœ‰ä¼˜æƒ åˆ¸æœ‰æ•ˆæœŸè‡³2026å¹´');
  } else {
    console.log('âœ… ä¼˜æƒ åˆ¸å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
  }

  // ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…ä¼˜æƒ åˆ¸
  const allUsers = await prisma.user.findMany({
    where: { role: 'CUSTOMER' },
  });

  const allCoupons = await prisma.coupon.findMany({
    where: { isActive: true },
  });

  if (allUsers.length > 0 && allCoupons.length > 0) {
    console.log('ðŸŽ« å¼€å§‹ä¸ºç”¨æˆ·åˆ†é…ä¼˜æƒ åˆ¸...');

    for (const user of allUsers) {
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»æœ‰ä¼˜æƒ åˆ¸
      const existingUserCoupons = await prisma.userCoupon.findMany({
        where: { userId: user.id },
      });

      if (existingUserCoupons.length === 0) {
        // ä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…å‰3å¼ ä¼˜æƒ åˆ¸
        const couponsToAssign = allCoupons.slice(0, 3);

        for (const coupon of couponsToAssign) {
          await prisma.userCoupon.create({
            data: {
              userId: user.id,
              couponId: coupon.id,
              isUsed: false,
              obtainedAt: new Date(),
            },
          });
        }

        console.log(`   âœ… å·²ä¸ºç”¨æˆ· ${user.username} åˆ†é… ${couponsToAssign.length} å¼ ä¼˜æƒ åˆ¸`);
      }
    }

    console.log('ðŸŽ« ç”¨æˆ·ä¼˜æƒ åˆ¸åˆ†é…å®Œæˆï¼');
  }

  console.log('ðŸŽ‰ æ•°æ®åº“ç§å­æ•°æ®åˆå§‹åŒ–å®Œæˆï¼');
}

main()
  .catch((e) => {
    console.error('âŒ ç§å­æ•°æ®åˆå§‹åŒ–å¤±è´¥:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
